<script>
  const labels = [
    "Capability", "Motivation", "Connectivity", "Segmentation",
    "Influence", "Norms", "Processes", "Governance", "Resources"
  ];

  const labelColors = {
    "Capability": "#F4B5A1",
    "Motivation": "#F4B5A1",
    "Connectivity": "#90A4B5",
    "Segmentation": "#90A4B5",
    "Influence": "#90A4B5",
    "Norms": "#93AB94",
    "Processes": "#93AB94",
    "Governance": "#93AB94",
    "Resources": "#93AB94"
  };

  const form = document.getElementById("scoreForm");
  labels.forEach(label => {
    const row = document.createElement("div");
    row.className = "input-row";
    const select = document.createElement("select");
    select.name = label;
    for (let i = 1; i <= 5; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = i;
      select.appendChild(opt);
    }
    const labelEl = document.createElement("label");
    labelEl.textContent = label;
    labelEl.htmlFor = label;
    row.appendChild(labelEl);
    row.appendChild(select);
    form.appendChild(row);
  });

  const ctx = document.getElementById("radarChart").getContext("2d");
  let radarChart;

  function getScoresFromForm() {
    return labels.map(label => parseFloat(document.querySelector(`select[name='${label}']`).value));
  }

  function drawChart(scores, showLabels = false, scaleMultiplier = 1) {
    if (radarChart) radarChart.destroy();
    radarChart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Your Scores',
          data: scores,
          fill: true,
          backgroundColor: 'rgba(68, 68, 68, 0.3)',
          borderColor: '#444444',
          pointBackgroundColor: labels.map(label => labelColors[label]),
          pointBorderColor: '#444444',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: labels.map(label => labelColors[label])
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            min: 0,
            max: 5,
            ticks: {
              stepSize: 1,
              color: '#333',
              font: { size: 24 }
            },
            pointLabels: {
              display: showLabels,
              color: (ctx) => labelColors[ctx.chart.data.labels[ctx.index]],
              font: { size: 14, weight: 'bold' }
            },
            grid: {
              color: '#ccc',
              circular: true
            },
            angleLines: { color: '#ccc' }
          }
        },
        layout: { padding: { top: 0, bottom: 0, left: 0, right: 0 } },
        elements: {
          line: { borderWidth: 3, tension: 0 },
          point: { radius: 5 * scaleMultiplier }
        },
        plugins: {
          legend: { display: false },
          tooltip: { position: 'nearest' }
        }
      }
    });
  }

  drawChart(getScoresFromForm());

  document.getElementById("updateBtn").addEventListener("click", function (e) {
    e.preventDefault();

    const email = document.getElementById("userEmail").value.trim();
    const project = document.getElementById("projectName").value.trim();
    const scores = getScoresFromForm();
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    // Clear previous messages
    document.getElementById("emailError").textContent = "";
    document.getElementById("projectError").textContent = "";
    document.getElementById("submissionSuccess")?.remove();

    let hasError = false;

    if (!emailPattern.test(email)) {
      document.getElementById("emailError").textContent = "Please enter a valid email address.";
      hasError = true;
    }

    if (!project) {
      document.getElementById("projectError").textContent = "Please enter a project name.";
      hasError = true;
    }

    if (hasError) return;

    drawChart(scores);

    const params = new URLSearchParams();
    params.append("userEmail", email);
    params.append("projectName", project);
    labels.forEach((label, i) => {
      params.append(label, scores[i]);
    });

    fetch("https://script.google.com/macros/s/AKfycbysOTAgcHzVotjV3IuN5FFOH_hjccBNofymLv9kglrCzVkRnCG_Vy1fL_Vd10BLuj1G/exec", {
      method: "POST",
      mode: "no-cors",
      body: params
    });

    const successDiv = document.createElement("div");
    successDiv.id = "submissionSuccess";
    successDiv.style.color = "green";
    successDiv.style.fontSize = "0.9em";
    successDiv.style.marginTop = "10px";
    successDiv.textContent = "Your scores have been submitted!";
    document.getElementById("formContainer").appendChild(successDiv);
  });

  document.getElementById("downloadBtn").addEventListener("click", function (e) {
    e.preventDefault();
    const originalScores = getScoresFromForm();
    const scaledScores = originalScores.map(score => score * 1.3);
    drawChart(scaledScores, true, 1.5);

    setTimeout(() => {
      const chartCanvas = document.getElementById("radarChart");

      const tempCanvas = document.createElement("canvas");
      tempCanvas.width = chartCanvas.width;
      tempCanvas.height = chartCanvas.height;
      const tempCtx = tempCanvas.getContext("2d");

      tempCtx.fillStyle = "#ffffff";
      tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
      tempCtx.drawImage(chartCanvas, 0, 0);

      const link = document.createElement("a");
      link.download = "radar_chart.png";
      link.href = tempCanvas.toDataURL("image/png");
      link.click();

      drawChart(originalScores, false);
    }, 300);
  });
</script>
